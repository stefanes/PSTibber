# GraphQL over WebSocket

The live consumption data, generated by e.g. *Tibber Pulse* or *Watty*, is served as a GraphQL subscription. This protocol is defined here: [GraphQL over WebSocket Protocol](https://github.com/enisdenjo/graphql-ws/blob/master/PROTOCOL.md)

## Usage

Since GraphQL subscriptions are handled as streams over a persistent connection (WebSocket), the process for accessing this data is a bit different compared to from traditional APIs:

1. Connect to the GraphQL subscription endpoint and initialize connection
2. Subscribe to data streamed from the GraphQL subscription endpoint
3. Read data from stream
4. Unsubscribe from data stream and close connection

### Connect to endpont and initialize

**Step 1** is handled by the function `Connect-TibberWebSocket`:

```powershell
$connection = Connect-TibberWebSocket
Write-Host "New connection created: $($connection.WebSocket.State)"
```

### Subscribe to data stream

To subscribe to the live consumption data stream (**step 2**) call the function `New-TibberLiveConsumptionSubscription`, passing the connection object returned from the previous call:

```powershell
$subscription = New-TibberLiveConsumptionSubscription -Connection $connection -HomeId '96a14971-525a-4420-aae9-e5aedaa129ff'
Write-Host "New GraphQL subscription created: $($subscription.Id)"
```

### Read data stream

Data is read (**step 3**) by calling the function ` ` and providing a callback script block:

```powershell
Read-TibberWebSocket -Connection $connection -Callback { param($data)
    Write-Host "Data read from stream: $data"
}
```

Or if you have a function defined to handle the data:

```poweshell
function Write-DataToHost {
    param (
        [string] $data
    )
    Write-Host "Data read from stream: $data"
}
Read-TibberWebSocket -Connection $connection -Callback ${function:Write-DataToHost}
```

### Unsubscribe and close connection

**Step 4** is dine by unsubscribing from the data stream using `Remove-TibberLiveConsumptionSubscription` and closing the WebSocket connection using `Disconnect-TibberWebSocket`:

```powershell
Remove-TibberLiveConsumptionSubscription -Connection $connection -Subscription $subscription
Write-Host "New GraphQL subscription with Id $($subscription.Id) stopped"

Disconnect-TibberWebSocket -Connection $connection
```
