# GraphQL over WebSocket

The live consumption data, generated by e.g. *Tibber Pulse* or *Watty*, is served as a GraphQL subscription. This protocol is defined here: [GraphQL over WebSocket Protocol](https://github.com/enisdenjo/graphql-ws/blob/master/PROTOCOL.md)

## Usage

Since GraphQL subscriptions are handled as streams over a persistent connection (WebSocket), the process for accessing this data is a bit different compared to REST APIs:

1. Connect to the GraphQL subscription endpoint and initialize connection
2. Subscribe to data streamed from the GraphQL subscription endpoint
3. Read data from stream
4. Unsubscribe from data stream and close connection

### Connect to endpont and initialize

**Step 1** is handled by the function `Connect-TibberWebSocket`:

```powershell
$connection = Connect-TibberWebSocket
Write-Host "New connection created: $($connection.WebSocket.State)"
```

### Subscribe to data stream

To subscribe to the live consumption data stream (**step 2**) call the function `Register-TibberLiveConsumptionSubscription`, passing the connection object returned from the previous call:

```powershell
$subscription = Register-TibberLiveConsumptionSubscription -Connection $connection -HomeId '96a14971-525a-4420-aae9-e5aedaa129ff'
Write-Host "New GraphQL subscription created: $($subscription.Id)"
```

### Read data stream

Packages are read from the stream (**step 3**) by calling the function `Read-TibberWebSocket` and providing a callback `ScriptBlock`:

```powershell
Read-TibberWebSocket -Connection $connection -Callback { param($package)
    Write-Host "New package on WebSocket connection: $package"
}
```

Or if you have a function defined to handle the data:

```powershell
function Write-PackageToHost {
    param (
        [string] $package
    )
    Write-Host "New package on WebSocket connection: $package"
}
Read-TibberWebSocket -Connection $connection -Callback ${function:Write-PackageToHost}
```

#### Timeout or max package count

To limit the time we read package from the WebSocket, provide the `-TimeoutInSeconds` and/or the `-PackageCount` parameters:

```powershell
$result = Read-TibberWebSocket -Connection $connection -Callback ${function:Write-PackageToHost} -TimeoutInSeconds 30
Write-Host "Read $($result.NumberOfPackages) packages in $($result.ElapsedTimeInSeconds) seconds"

$result = Read-TibberWebSocket -Connection $connection -Callback ${function:Write-PackageToHost} -PackageCount 3
Write-Host "Read $($result.NumberOfPackages) packages in $($result.ElapsedTimeInSeconds) seconds"
```

### Unsubscribe and close connection

**Step 4** is done by unsubscribing from the data stream using `Unregister-TibberLiveConsumptionSubscription` and closing the WebSocket connection using `Disconnect-TibberWebSocket`:

```powershell
Unregister-TibberLiveConsumptionSubscription -Connection $connection -Subscription $subscription
Write-Host "New GraphQL subscription with Id $($subscription.Id) stopped"

Disconnect-TibberWebSocket -Connection $connection
```

### Example

Complete example of reading live consumption data for 30 seconds and gracefully closing the connection when done:

```powershell
function Write-PackageToHost {
    param (
        [Object] $Json
    )
    Write-Host "New Json document recieved: $($Json.payload.data | Out-String)"
}

# Get the home Id
$response = Get-TibberHome -Fields 'id', 'appNickname'
$homeId = ($response | Where-Object { $_.appNickname -eq 'Vitahuset' }).id

# Connect WebSocket and register a subscription
$connection = Connect-TibberWebSocket
$subscription = Register-TibberLiveConsumptionSubscription -Connection $connection -HomeId $homeId

# Read data stream
$result = Read-TibberWebSocket -Connection $connection -Callback ${function:Write-PackageToHost} -TimeoutInSeconds 30
Write-Host "Read $($result.NumberOfPackages) packages in $($result.ElapsedTimeInSeconds) seconds"

# Unregister subscription and close down the WebSocket connection
Unregister-TibberLiveConsumptionSubscription -Connection $connection -Subscription $subscription
Disconnect-TibberWebSocket -Connection $connection
```
